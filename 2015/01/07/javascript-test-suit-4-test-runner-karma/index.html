<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>[JavaScript] Test Suit 4 - Test Runner - Karma | Veck's Blog</title><link rel="stylesheet" type="text/css" href="/Veck//css/normalize.css"><link rel="stylesheet" type="text/css" href="/Veck//css/highlight.css"><link rel="stylesheet" type="text/css" href="/Veck//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/Veck/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/Veck/." class="title">Veck's Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item">Home</a><a href="/Veck/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>[JavaScript] Test Suit 4 - Test Runner - Karma</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2015-01-07</div></div></div><article><div class="container post"><h1 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h1><ol>
<li><code>npm install karma --save-dev</code> (official instruction, –save-dev will register in dependency package)</li>
<li>Karma 用 <code>npm install -g</code> 安裝後沒辦法直接輸入使用，要用路徑去執行，但是我改用 nvm 安裝 node.js 所以導致路徑很冗長，所以官網的安裝方式建議是直接針對你要進行測試的專案作個別安裝，這樣路徑也會比較短，我有在我的 .bashrc 中加入<code>alias karma=&#39;./node_modules/karma/bin/karma&#39;</code> </li>
</ol>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>karma 主要用來驅動測試，但還可以設定使用的 test framework (test runner: mocha, jasime,…etc.)、測試起始路徑 basePath(如果有設定的話，這個路徑會被加到 files list 中，然後在啟動的瀏覽器中加到 javascript 屬性 src 中作為 prefix)、設定要使用的瀏覽器、哪些檔案要被載入以便存取使用、哪些檔案只觀察變化用、哪些檔案要被排除、瀏覽器啟動時要用 port、預處理器…等等</p>
<h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><ol>
<li>建立 config 檔案：<code>karma init &lt;name&gt;.config.js</code></li>
</ol>
<p><img src="http://user-image.logdown.io/user/3330/blog/3407/post/248538/B1ph4BcQSxCb5A7RubJj_init.png" alt="init.png"></p>
<h5 id="my-config-js"><a href="#my-config-js" class="headerlink" title="my.config.js"></a>my.config.js</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Karma configuration&#10;// Generated on Wed Jan 07 2015 16:18:19 GMT+0800 (CST)&#10;&#10;module.exports = function(config) &#123;&#10;  config.set(&#123;&#10;&#10;    // base path that will be used to resolve all patterns (eg. files, exclude)&#10;    basePath: &#39;&#39;,&#10;&#10;&#10;    // frameworks to use&#10;    // available frameworks: https://npmjs.org/browse/keyword/karma-adapter&#10;    frameworks: [&#39;mocha&#39;],&#10;&#10;&#10;    // list of files / patterns to load in the browser&#10;    files: [&#10;      &#39;test.js&#39;&#10;    ],&#10;&#10;&#10;    // list of files to exclude&#10;    exclude: [&#10;    ],&#10;&#10;&#10;    // preprocess matching files before serving them to the browser&#10;    // available preprocessors: https://npmjs.org/browse/keyword/karma-preprocessor&#10;    preprocessors: &#123;&#10;    &#125;,&#10;&#10;&#10;    // test results reporter to use&#10;    // possible values: &#39;dots&#39;, &#39;progress&#39;&#10;    // available reporters: https://npmjs.org/browse/keyword/karma-reporter&#10;    reporters: [&#39;progress&#39;],&#10;&#10;&#10;    // web server port&#10;    port: 9876,&#10;&#10;&#10;    // enable / disable colors in the output (reporters and logs)&#10;    colors: true,&#10;&#10;&#10;    // level of logging&#10;    // possible values: config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG&#10;    logLevel: config.LOG_INFO,&#10;&#10;&#10;    // enable / disable watching file and executing tests whenever any file changes&#10;    autoWatch: true,&#10;&#10;&#10;    // start these browsers&#10;    // available browser launchers: https://npmjs.org/browse/keyword/karma-launcher&#10;    browsers: [&#39;Chrome&#39;],&#10;&#10;&#10;    // Continuous Integration mode&#10;    // if true, Karma captures browsers, runs the tests and exits&#10;    singleRun: false&#10;  &#125;);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>2.啟動 karma 來進行測試工作：<code>karma start &lt;name&gt;.config.js</code></p>
<h1 id="karma-mocha-chai-sinon"><a href="#karma-mocha-chai-sinon" class="headerlink" title="karma-mocha-chai-sinon"></a>karma-mocha-chai-sinon</h1><h2 id="Notice"><a href="#Notice" class="headerlink" title="Notice"></a>Notice</h2><p>karma 啟動瀏覽器來執行測試，會找不到 node.js 的 require()，它好像是用 RequireJS 來做為引入 module 的方法</p>
<p>#####stack-overflow<br><img src="http://user-image.logdown.io/user/3330/blog/3407/post/248538/5c7kOp7CSF6cNWYS7KOR_stackoverflow.png" alt="stackoverflow.png"></p>
<p>但是 sinon 和 assert 都要用 require 來引用模組啊！儘管用了 require.js ，還是會因為載入慢導致在啟動瀏覽器後來找不到 sinon<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Chrome 39.0.2171 (Mac OS X 10.10.1) ERROR&#10;  Uncaught Error: Module name &#34;sinon&#34; has not been loaded yet for context: _. Use require([])&#10;  http://requirejs.org/docs/errors.html#notloaded&#10;  at /Users/veck/Desktop/JSTest/5/node_modules/requirejs/require.js:141</span><br></pre></td></tr></table></figure></p>
<p>注意到 npm 上有 karma-chai 和 karma-sinon 這兩個專案，做法都是安裝 plugin 後，只要在 config.js 的 framework 填入 ‘sinon’ 和 ‘chai’，就可以直接在 test 中 <strong>不用</strong> require 就使用 sinon 和 chai 物件</p>
<p>##karma-sinon<br>先來解決使用 sinon 的問題：</p>
<ol>
<li><code>npm install karma-sinon</code></li>
<li>修改 <name>.config.js 的 frameworks：<code>frameworks: [&#39;mocha&#39;, &#39;sinon&#39;]</code></name></li>
<li>修改 test.js，不需要 var sinon = require(‘sinon’) 了，這設計很方便的直接可以用</li>
<li><code>karma start &lt;name&gt;.config.js</code> !</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Chrome 39.0.2171 (Mac OS X 10.10.1) mocha-chai-sino calls the original Functionn FAILED&#10;&#9;ReferenceError: assert is not defined&#10;&#9;    at Context.&#60;anonymous&#62; (/Users/veck/Desktop/JSTest/test_karma/test.js:24:7)&#10;Chrome 39.0.2171 (Mac OS X 10.10.1): Executed 1 of 1 (1 FAILED) ERROR (0.014 secs / 0.003 secs)</span><br></pre></td></tr></table></figure>
<p>OK！解決了找不到 require 和 sinon 沒有載入的問題，剩下 assert </p>
<h2 id="karma-chai"><a href="#karma-chai" class="headerlink" title="karma-chai"></a>karma-chai</h2><p>node.js 原本的 assert module 還是要 require 才能用，想起在學 chai 的時候，chai 的官網有說 chai 也有實現 traditional style assert，因此 assert 可以用 karma-chai 的 chai 來實現了</p>
<ol>
<li><code>npm install karma-chai</code></li>
<li>修改 <name>.config.js 的 frameworks：<code>frameworks: [&#39;mocha&#39;, &#39;sinon&#39;, &#39;chai&#39;]</code></name></li>
<li>修改 test.js，不需要 var assert = require(‘assert’) 了</li>
<li><code>karma start &lt;name&gt;.config.js</code> !</li>
<li>YA!</li>
</ol>
<p><img src="http://user-image.logdown.io/user/3330/blog/3407/post/248538/6iyNootOSpS0xOtzRMfW_success.png" alt="success.png"></p>
<p>最後整個 test.js：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* function under test */&#10;function once(fn) &#123;&#10;   var returnValue, called = false;&#10;   return function () &#123;&#10;      if (!called) &#123;&#10;         called = true;&#10;         returnValue = fn.apply(this, arguments);&#10;      &#125;&#10;      return returnValue;&#10;   &#125;;&#10;&#125;&#10;&#10;/* test code */&#10;describe(&#34;karma-mocha-chai-sino&#34;, function()&#123;&#10;   it(&#34;calls the original Functionn&#34;, function () &#123;&#10;      var callback = sinon.spy();// &#24314;&#31435; sinon.spy &#29289;&#20214;&#10;      var proxy = once(callback);&#10;&#10;      proxy();&#10;&#10;      assert(callback.called);&#10;   &#125;)&#10;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>解到此時，正好休息去洗了個澡，想說既然這 sinon 和 chai 的組合很常在 JavaScript unit test 中用到，應該可以寫個 karma 和 sinon 及 chai 的 plugin，就不用安裝和設定兩次 frameworks 了，先上網查了一下，果然也有人整了一個 karma-sinon-chai，config.js 那邊要用 sinon-chai 這個 framework name</p>
<p>如此一來，就解決 karma 是 browser-based 的問題了！</p>
<h2 id="Refernce"><a href="#Refernce" class="headerlink" title="Refernce"></a>Refernce</h2><ul>
<li><a href="http://karma-runner.github.io/0.12/dev/plugins.html" target="_blank" rel="external">karma plugins</a></li>
<li><a href="https://github.com/karma-runner/karma-mocha" target="_blank" rel="external">karma-mocha</a></li>
<li><a href="https://github.com/yanoosh/karma-sinon" target="_blank" rel="external">karma-sinon</a></li>
<li><a href="https://github.com/xdissent/karma-chai" target="_blank" rel="external">karma-chai</a></li>
<li><a href="https://github.com/kmees/karma-sinon-chai" target="_blank" rel="external">karma-sinon-chai</a></li>
</ul>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'vecktw';
var disqus_identifier = '2015/01/07/javascript-test-suit-4-test-runner-karma/';
var disqus_title = '[JavaScript] Test Suit 4 - Test Runner - Karma';
var disqus_url = 'http://fbukevin.github.io/Veck/2015/01/07/javascript-test-suit-4-test-runner-karma/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:fbukevin@gmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="http://twitter.com/VeckHsiao" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/fbukevin" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Veck's Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>