<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>[Python] Requests + Google Finance API | Veck's Blog</title><link rel="stylesheet" type="text/css" href="/Veck//css/normalize.css"><link rel="stylesheet" type="text/css" href="/Veck//css/highlight.css"><link rel="stylesheet" type="text/css" href="/Veck//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/Veck/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/Veck/." class="title">Veck's Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item">Home</a><a href="/Veck/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>[Python] Requests + Google Finance API</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2015-10-29</div></div></div><article><div class="container post"><p>本文是要介紹如何使用 <em>Python</em> 的 <code>request</code> 模組來呼叫 Google Finance API 並解析取得的股價內容。</p>
<p>有關 requests 模組的介紹，請參考：<a href="http://docs.python-requests.org/en/latest/user/quickstart/" target="_blank" rel="external">http://docs.python-requests.org/en/latest/user/quickstart/</a></p>
<p>首先當然就是要安裝 request 模組啦！</p>
<p><code>pip install requests</code></p>
<p>然後就可以開始寫程式了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>r = requests.get(<span class="string">"https://finance.google.com/finance/info"</span>, params = &#123;<span class="string">"client"</span>:<span class="string">"ig"</span>, <span class="string">"q"</span>:<span class="string">"TPE:2330"</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>這段是以 HTTP GET 方法呼叫 Google Finance 的 API，可以得到不同國家區域證券交易所提供的即時股價資訊，requests 物件的 get 方法可以給予兩個參數，第一個參數是資源的 URI，第二個參數是相關設定，項目很多種，這裡我們用來設定 GET 傳輸所夾帶的資料，有 <code>client</code> (通常設定 “ig”) 和 <code>q</code> (query string 的意思，格式為 <code>&lt;證券交易所代碼&gt;:&lt;股票代碼&gt;</code>)，本例整個發送的資源敘述會變成：</p>
<p><code>https://finance.google.com/finance/info?client=ig&amp;q=TPE:2330</code></p>
<p>如果成功取得回應資源，我們可以用 <code>r.text</code> 來查看回應內容本文，用 <code>print()</code> 可以印的比較漂亮點(人類可讀)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(r.text) 		<span class="comment">#pretty output</span></span><br><span class="line">// [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"id"</span>: <span class="string">"674465"</span></span><br><span class="line">,<span class="string">"t"</span> : <span class="string">"2330"</span></span><br><span class="line">,<span class="string">"e"</span> : <span class="string">"TPE"</span></span><br><span class="line">,<span class="string">"l"</span> : <span class="string">"138.00"</span></span><br><span class="line">,<span class="string">"l_fix"</span> : <span class="string">"138.00"</span></span><br><span class="line">,<span class="string">"l_cur"</span> : <span class="string">"NT$138.00"</span></span><br><span class="line">,<span class="string">"s"</span>: <span class="string">"0"</span></span><br><span class="line">,<span class="string">"ltt"</span>:<span class="string">"1:30PM GMT+8"</span></span><br><span class="line">,<span class="string">"lt"</span> : <span class="string">"Oct 28, 1:30PM GMT+8"</span></span><br><span class="line">,<span class="string">"lt_dts"</span> : <span class="string">"2015-10-28T13:30:02Z"</span></span><br><span class="line">,<span class="string">"c"</span> : <span class="string">"-1.00"</span></span><br><span class="line">,<span class="string">"c_fix"</span> : <span class="string">"-1.00"</span></span><br><span class="line">,<span class="string">"cp"</span> : <span class="string">"-0.72"</span></span><br><span class="line">,<span class="string">"cp_fix"</span> : <span class="string">"-0.72"</span></span><br><span class="line">,<span class="string">"ccol"</span> : <span class="string">"chr"</span></span><br><span class="line">,<span class="string">"pcls_fix"</span> : <span class="string">"139"</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>##Parse Response String<br>假如回傳的資料內容確定是 JSON 格式內容，你可以用 <code>r.json()</code> 來 parse 出內容，但是注意回傳的內容，雖然長得很像 JSON 的格式，但是在整個字串最前面多了兩個 ‘/‘，這導致這個物件並不是 JSON 物件，呼叫 <code>r.json()</code> 會出錯誤，因此我們需要先處理掉這兩個反斜線。</p>
<p>由於 JSON 的字串物件無法直接替換掉字串指定索引的內容，所以我採用複製子字串的方式來取得不帶有反斜線的其他內容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s = r.text[<span class="number">4</span>:] 		<span class="comment">#copy from "["</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> json</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>o = json.loads(s)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>o[<span class="number">0</span>][<span class="string">'l'</span>]</span><br><span class="line"><span class="string">u'138.00'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> decimal</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d = decimal.Decimal(o[<span class="number">0</span>][<span class="string">'l'</span>])</span><br><span class="line">Decimal(<span class="string">'138.00'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>int(d)</span><br><span class="line"><span class="number">138</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>float(d)</span><br><span class="line"><span class="number">138.0</span></span><br></pre></td></tr></table></figure>
<p>補充一下，<code>requests.get()</code> 帶的第二個參數，用 <code>params</code> 和 <code>data</code> 是不同的項目喔，如果用 <code>data</code>，會得到 <code>Bad request</code>。</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'vecktw';
var disqus_identifier = '2015/10/29/python-requests-google-finance-api/';
var disqus_title = '[Python] Requests + Google Finance API';
var disqus_url = 'http://fbukevin.github.io/Veck/2015/10/29/python-requests-google-finance-api/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:fbukevin@gmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="http://twitter.com/VeckHsiao" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/fbukevin" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Veck's Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>